<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1" />
<meta name="generator" content="pdoc 0.9.1" />
<title>tests.MDR_test_DTI API documentation</title>
<meta name="description" content="MODEL DRIVEN REGISTRATION for iBEAt study: quantitative renal MRI
@Kanishka Sharma 2021
Test script for DTI sequence using Model driven registration â€¦" />
<link rel="preload stylesheet" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/10up-sanitize.css/11.0.1/sanitize.min.css" integrity="sha256-PK9q560IAAa6WVRRh76LtCaI8pjTJ2z11v0miyNNjrs=" crossorigin>
<link rel="preload stylesheet" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/10up-sanitize.css/11.0.1/typography.min.css" integrity="sha256-7l/o7C8jubJiy74VsKTidCy1yBkRtiUGbVkYBylBqUg=" crossorigin>
<link rel="stylesheet preload" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.1.1/styles/github.min.css" crossorigin>
<style>:root{--highlight-color:#fe9}.flex{display:flex !important}body{line-height:1.5em}#content{padding:20px}#sidebar{padding:30px;overflow:hidden}#sidebar > *:last-child{margin-bottom:2cm}.http-server-breadcrumbs{font-size:130%;margin:0 0 15px 0}#footer{font-size:.75em;padding:5px 30px;border-top:1px solid #ddd;text-align:right}#footer p{margin:0 0 0 1em;display:inline-block}#footer p:last-child{margin-right:30px}h1,h2,h3,h4,h5{font-weight:300}h1{font-size:2.5em;line-height:1.1em}h2{font-size:1.75em;margin:1em 0 .50em 0}h3{font-size:1.4em;margin:25px 0 10px 0}h4{margin:0;font-size:105%}h1:target,h2:target,h3:target,h4:target,h5:target,h6:target{background:var(--highlight-color);padding:.2em 0}a{color:#058;text-decoration:none;transition:color .3s ease-in-out}a:hover{color:#e82}.title code{font-weight:bold}h2[id^="header-"]{margin-top:2em}.ident{color:#900}pre code{background:#f8f8f8;font-size:.8em;line-height:1.4em}code{background:#f2f2f1;padding:1px 4px;overflow-wrap:break-word}h1 code{background:transparent}pre{background:#f8f8f8;border:0;border-top:1px solid #ccc;border-bottom:1px solid #ccc;margin:1em 0;padding:1ex}#http-server-module-list{display:flex;flex-flow:column}#http-server-module-list div{display:flex}#http-server-module-list dt{min-width:10%}#http-server-module-list p{margin-top:0}.toc ul,#index{list-style-type:none;margin:0;padding:0}#index code{background:transparent}#index h3{border-bottom:1px solid #ddd}#index ul{padding:0}#index h4{margin-top:.6em;font-weight:bold}@media (min-width:200ex){#index .two-column{column-count:2}}@media (min-width:300ex){#index .two-column{column-count:3}}dl{margin-bottom:2em}dl dl:last-child{margin-bottom:4em}dd{margin:0 0 1em 3em}#header-classes + dl > dd{margin-bottom:3em}dd dd{margin-left:2em}dd p{margin:10px 0}.name{background:#eee;font-weight:bold;font-size:.85em;padding:5px 10px;display:inline-block;min-width:40%}.name:hover{background:#e0e0e0}dt:target .name{background:var(--highlight-color)}.name > span:first-child{white-space:nowrap}.name.class > span:nth-child(2){margin-left:.4em}.inherited{color:#999;border-left:5px solid #eee;padding-left:1em}.inheritance em{font-style:normal;font-weight:bold}.desc h2{font-weight:400;font-size:1.25em}.desc h3{font-size:1em}.desc dt code{background:inherit}.source summary,.git-link-div{color:#666;text-align:right;font-weight:400;font-size:.8em;text-transform:uppercase}.source summary > *{white-space:nowrap;cursor:pointer}.git-link{color:inherit;margin-left:1em}.source pre{max-height:500px;overflow:auto;margin:0}.source pre code{font-size:12px;overflow:visible}.hlist{list-style:none}.hlist li{display:inline}.hlist li:after{content:',\2002'}.hlist li:last-child:after{content:none}.hlist .hlist{display:inline;padding-left:1em}img{max-width:100%}td{padding:0 .5em}.admonition{padding:.1em .5em;margin-bottom:1em}.admonition-title{font-weight:bold}.admonition.note,.admonition.info,.admonition.important{background:#aef}.admonition.todo,.admonition.versionadded,.admonition.tip,.admonition.hint{background:#dfd}.admonition.warning,.admonition.versionchanged,.admonition.deprecated{background:#fd4}.admonition.error,.admonition.danger,.admonition.caution{background:lightpink}</style>
<style media="screen and (min-width: 700px)">@media screen and (min-width:700px){#sidebar{width:30%;height:100vh;overflow:auto;position:sticky;top:0}#content{width:70%;max-width:100ch;padding:3em 4em;border-left:1px solid #ddd}pre code{font-size:1em}.item .name{font-size:1em}main{display:flex;flex-direction:row-reverse;justify-content:flex-end}.toc ul ul,#index ul{padding-left:1.5em}.toc > ul > li{margin-top:.5em}}</style>
<style media="print">@media print{#sidebar h1{page-break-before:always}.source{display:none}}@media print{*{background:transparent !important;color:#000 !important;box-shadow:none !important;text-shadow:none !important}a[href]:after{content:" (" attr(href) ")";font-size:90%}a[href][title]:after{content:none}abbr[title]:after{content:" (" attr(title) ")"}.ir a:after,a[href^="javascript:"]:after,a[href^="#"]:after{content:""}pre,blockquote{border:1px solid #999;page-break-inside:avoid}thead{display:table-header-group}tr,img{page-break-inside:avoid}img{max-width:100% !important}@page{margin:0.5cm}p,h2,h3{orphans:3;widows:3}h1,h2,h3,h4,h5,h6{page-break-after:avoid}}</style>
<script defer src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.1.1/highlight.min.js" integrity="sha256-Uv3H6lx7dJmRfRvH8TH6kJD1TSK1aFcwgx+mdg3epi8=" crossorigin></script>
<script>window.addEventListener('DOMContentLoaded', () => hljs.initHighlighting())</script>
</head>
<body>
<main>
<article id="content">
<header>
<h1 class="title">Module <code>tests.MDR_test_DTI</code></h1>
</header>
<section id="section-intro">
<p>MODEL DRIVEN REGISTRATION for iBEAt study: quantitative renal MRI
@Kanishka Sharma 2021
Test script for DTI sequence using Model driven registration Library</p>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">&#34;&#34;&#34;
MODEL DRIVEN REGISTRATION for iBEAt study: quantitative renal MRI
@Kanishka Sharma 2021
Test script for DTI sequence using Model driven registration Library
&#34;&#34;&#34;
import sys
import glob
import os
import numpy as np
import itk
import SimpleITK as sitk
import pydicom
from pathlib import Path 
import importlib
import time
from PIL import Image
from MDR.MDR import model_driven_registration  


np.set_printoptions(threshold=sys.maxsize)


def main():
    # selected sequence to process
    sequence = &#39;DTI&#39;
    # number of expected slices to process (example: iBEAt study number of slice = 30)
    slices = 30    

    # path definition  
    # your &#39;os.getcwd()&#39; path should point to your local directory containing the  MDR-Library 
    # eg: /Users/kanishkasharma/Documents/GitHub/MDR_Library
    print(os.getcwd()) 

    DATA_PATH = os.getcwd() + r&#39;/tests/test_data/DICOMs&#39;
    OUTPUT_REG_PATH = os.getcwd() + r&#39;/MDR_registration_output&#39;
    Elastix_Parameter_file_PATH = os.getcwd() + r&#39;/Elastix_Parameters_Files/iBEAt&#39; 
    output_dir =  OUTPUT_REG_PATH + &#39;/DTI/&#39;

    # Organize files per each sequence:
    os.chdir(DATA_PATH)    
    # list all patient folders available to be processed
    patients_folders = os.listdir()
    # select patient folder to be processed from the list of available patient DICOMs supplied in patients_folders
    for patient_folder in patients_folders:
        if patient_folder not in [&#39;test_case_iBEAt_4128009&#39;]: # eg: test case selected to be processed - change to your own test case
            continue
        # read path to the sequence to be processed for selected test patient case: eg: DTI
        sequence_images_path = patient_folder + &#39;/&#39; + str(sequence) + &#39;/DICOM&#39;
        os.chdir(DATA_PATH + &#39;/&#39; + sequence_images_path)
        # read all dicom files for selected sequence
        dcm_files_found = glob.glob(&#34;*.dcm&#34;)
        if not dcm_files_found:
            dcm_files_found = glob.glob(&#34;*.IMA&#34;) # if sequence is IMA format instead of dcm
        # slice to be processed from selected sequence
        for slice in range(1, slices+1):
            current_slice = sequence + &#39;_slice_&#39; + str(slice)
            # single slice processing for DTI sequence (here selected slice number is 15)
            if current_slice not in [sequence + &#39;_slice_15&#39;]:
                continue
            # read slice path to be processed
            slice_path = DATA_PATH + &#39;/&#39; + sequence_images_path + &#39;/&#39; + current_slice
            data = Path(slice_path)
            # list of all DICOMs to be processed for the selected slice (example: slice number = 15 here)
            lstFilesDCM = list(data.glob(&#39;**/*.IMA&#39;)) 
    
            # read all dicom files for the selected sequence and slice
            files, ArrayDicomiBEAt, filenameDCM = read_DICOM_files(lstFilesDCM)
            # get sitk image parameters for registration (origin and spacing)
            image_parameters = get_sitk_image_details_from_DICOM(slice_path)
            # sort slices correctly - based on acquisition time for model driven registration
            sorted_slice_files = sort_all_slice_files_acquisition_time(files)
            # run DTI MDR test 
            iBEAt_test_DTI(Elastix_Parameter_file_PATH, output_dir, sorted_slice_files, ArrayDicomiBEAt, image_parameters, filenameDCM, lstFilesDCM)

# read input dicom files
def read_DICOM_files(lstFilesDCM):
    files = []
    RefDs = pydicom.dcmread(lstFilesDCM[0])
    SeriesPixelDims = (int(RefDs.Rows), int(RefDs.Columns), len(lstFilesDCM))           
    ArrayDicomiBEAt = np.zeros(SeriesPixelDims, dtype=RefDs.pixel_array.dtype)

    # read all dicoms and output dicom files
    for filenameDCM in lstFilesDCM: 
        files.append(pydicom.dcmread(filenameDCM))
        ds = pydicom.dcmread(filenameDCM)
        # write pixel data into numpy array
        ArrayDicomiBEAt[:, :, lstFilesDCM.index(filenameDCM)] = ds.pixel_array  

    return files, ArrayDicomiBEAt, filenameDCM

# get input image origin and spacing to set the numpy arrays for registration
def get_sitk_image_details_from_DICOM(slice_path):
    reader = sitk.ImageSeriesReader()
    dicom_names = reader.GetGDCMSeriesFileNames(slice_path)
    reader.SetFileNames(dicom_names)
    image = reader.Execute()
    spacing = image.GetSpacing() 
    return spacing

# sort all input slices based on acquisition time
def sort_all_slice_files_acquisition_time(files):
    slice_sorted_acq_time = []
    skipcount = 0
    for f in files: 
        if hasattr(f, &#39;AcquisitionTime&#39;):
            slice_sorted_acq_time.append(f)
        else:
            skipcount = skipcount + 1
    print(&#34;skipped, no AcquisitionTime: {}&#34;.format(skipcount))

    return sorted(slice_sorted_acq_time, key=lambda s: s.AcquisitionTime)  

# test DTI using model driven registration
def iBEAt_test_DTI(Elastix_Parameter_file_PATH, output_dir, sorted_slice_files, ArrayDicomiBEAt, image_parameters, filenameDCM, lstFilesDCM):
    &#34;&#34;&#34; Example application of MDR in renal DTI (iBEAt data)
    
    Args
    ----
    Elastix_Parameter_file_PATH (string): complete path to the elastix parameter file to be used
    output_dir (string): directory where results are saved
    slice_sorted_files (list): selected slices to process using MDR: sorted according to acquisition time 
    ArrayDicomiBEAt (numpy.ndarray): input DICOM to numpy array (unsorted)
    image_parameters (SITK input): image spacing
    filenameDCM (pathlib.PosixPath): dicom filenames to process
    lstFilesDCM (list): list of dicom files to process

    Description
    -----------
    This function performs model driven registration for selected DTI sequence on a single selected slice 
    and returns as output the MDR registered images, signal model fit, deformation field x, deformation field y, 
    fitted parameters FA and ADC, and the final diagnostics.
    &#34;&#34;&#34;
    start_computation_time = time.time()
    # define numpy array with same input shape as original DICOMs
    image_shape = np.shape(ArrayDicomiBEAt)
    original_images = np.zeros(image_shape)

    # initialise original_images with sorted acquisiton times to run MDR
    for i, s in enumerate(sorted_slice_files):
        img2d = s.pixel_array
        original_images[:, :, i] = img2d

    # read signal model parameters
    full_module_name = &#34;models.iBEAt_DTI&#34;
    signal_model_parameters = read_signal_model_parameters(full_module_name,filenameDCM, lstFilesDCM)
    # read signal model parameters
    elastix_model_parameters = read_elastix_model_parameters(Elastix_Parameter_file_PATH)
    
    #Perform MDR 
    MDR_output = model_driven_registration(original_images, image_parameters, signal_model_parameters, elastix_model_parameters, precision = 1)

    #Export results
    export_images(MDR_output[0], output_dir +&#39;/coregistered/MDR-registered_DTI_&#39;)
    export_images(MDR_output[1], output_dir +&#39;/fit/fit_image_&#39;)
    export_images(MDR_output[2][:,:,0,:], output_dir +&#39;/deformation_field/final_deformation_x_&#39;)
    export_images(MDR_output[2][:,:,1,:], output_dir +&#39;/deformation_field/final_deformation_y_&#39;)
    export_maps(MDR_output[3][2::4], output_dir + &#39;/fitted_parameters/FA&#39;, np.shape(original_images))
    export_maps(MDR_output[3][3::4], output_dir + &#39;/fitted_parameters/ADC&#39;, np.shape(original_images))
    MDR_output[4].to_csv(output_dir + &#39;DTI_largest_deformations.csv&#39;)

    # Report computation times
    end_computation_time = time.time()
    print(&#34;total computation time for MDR (minutes taken:)...&#34;)
    print(0.0166667*(end_computation_time - start_computation_time)) # in minutes
    print(&#34;completed MDR registration!&#34;)
    print(&#34;Finished processing Model Driven Registration case for iBEAt study DTI sequence!&#34;)



## read sequence acquisition parameter for signal modelling
def read_signal_model_parameters(full_module_name, filenameDCM, lstFilesDCM):

    # generate a module named as a string
    MODEL = importlib.import_module(full_module_name)
    b_values, bVec_original, image_orientation_patient = MODEL.read_dicom_tags_DTI(filenameDCM, lstFilesDCM)
    # select signal model paramters
    signal_model_parameters = [MODEL]
    signal_model_parameters.append([b_values, bVec_original, image_orientation_patient])
    return signal_model_parameters


## read elastix parameters
def read_elastix_model_parameters(Elastix_Parameter_file_PATH):
    elastix_model_parameters = itk.ParameterObject.New()
    elastix_model_parameters.AddParameterFile(Elastix_Parameter_file_PATH + &#34;/BSplines_DTI.txt&#34;)
    elastix_model_parameters.SetParameter(&#39;MaximumNumberOfIterations&#39;, &#39;1024&#39;)
    return elastix_model_parameters


## Save MDR results to folder
def export_images(MDR_output, folder):
    shape = np.shape(MDR_output)
    for i in range(shape[2]):
        im = Image.fromarray(MDR_output[:,:,i])
        im.save(folder + str(i) + &#34;.tiff&#34;)


## Fitted Parameters to output folder
def export_maps(MDR_output, folder, shape):
    array = np.reshape(MDR_output, [shape[0],shape[1]]) 
    Img = Image.fromarray(array)
    Img.save(folder + &#34;.tiff&#34;)
    




    </code></pre>
</details>
</section>
<section>
</section>
<section>
</section>
<section>
<h2 class="section-title" id="header-functions">Functions</h2>
<dl>
<dt id="tests.MDR_test_DTI.export_images"><code class="name flex">
<span>def <span class="ident">export_images</span></span>(<span>MDR_output, folder)</span>
</code></dt>
<dd>
<div class="desc"></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def export_images(MDR_output, folder):
    shape = np.shape(MDR_output)
    for i in range(shape[2]):
        im = Image.fromarray(MDR_output[:,:,i])
        im.save(folder + str(i) + &#34;.tiff&#34;)</code></pre>
</details>
</dd>
<dt id="tests.MDR_test_DTI.export_maps"><code class="name flex">
<span>def <span class="ident">export_maps</span></span>(<span>MDR_output, folder, shape)</span>
</code></dt>
<dd>
<div class="desc"></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def export_maps(MDR_output, folder, shape):
    array = np.reshape(MDR_output, [shape[0],shape[1]]) 
    Img = Image.fromarray(array)
    Img.save(folder + &#34;.tiff&#34;)</code></pre>
</details>
</dd>
<dt id="tests.MDR_test_DTI.get_sitk_image_details_from_DICOM"><code class="name flex">
<span>def <span class="ident">get_sitk_image_details_from_DICOM</span></span>(<span>slice_path)</span>
</code></dt>
<dd>
<div class="desc"></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def get_sitk_image_details_from_DICOM(slice_path):
    reader = sitk.ImageSeriesReader()
    dicom_names = reader.GetGDCMSeriesFileNames(slice_path)
    reader.SetFileNames(dicom_names)
    image = reader.Execute()
    spacing = image.GetSpacing() 
    return spacing</code></pre>
</details>
</dd>
<dt id="tests.MDR_test_DTI.iBEAt_test_DTI"><code class="name flex">
<span>def <span class="ident">iBEAt_test_DTI</span></span>(<span>Elastix_Parameter_file_PATH, output_dir, sorted_slice_files, ArrayDicomiBEAt, image_parameters, filenameDCM, lstFilesDCM)</span>
</code></dt>
<dd>
<div class="desc"><p>Example application of MDR in renal DTI (iBEAt data)</p>
<h2 id="args">Args</h2>
<p>Elastix_Parameter_file_PATH (string): complete path to the elastix parameter file to be used
output_dir (string): directory where results are saved
slice_sorted_files (list): selected slices to process using MDR: sorted according to acquisition time
ArrayDicomiBEAt (numpy.ndarray): input DICOM to numpy array (unsorted)
image_parameters (SITK input): image spacing
filenameDCM (pathlib.PosixPath): dicom filenames to process
lstFilesDCM (list): list of dicom files to process</p>
<h2 id="description">Description</h2>
<p>This function performs model driven registration for selected DTI sequence on a single selected slice
and returns as output the MDR registered images, signal model fit, deformation field x, deformation field y,
fitted parameters FA and ADC, and the final diagnostics.</p></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def iBEAt_test_DTI(Elastix_Parameter_file_PATH, output_dir, sorted_slice_files, ArrayDicomiBEAt, image_parameters, filenameDCM, lstFilesDCM):
    &#34;&#34;&#34; Example application of MDR in renal DTI (iBEAt data)
    
    Args
    ----
    Elastix_Parameter_file_PATH (string): complete path to the elastix parameter file to be used
    output_dir (string): directory where results are saved
    slice_sorted_files (list): selected slices to process using MDR: sorted according to acquisition time 
    ArrayDicomiBEAt (numpy.ndarray): input DICOM to numpy array (unsorted)
    image_parameters (SITK input): image spacing
    filenameDCM (pathlib.PosixPath): dicom filenames to process
    lstFilesDCM (list): list of dicom files to process

    Description
    -----------
    This function performs model driven registration for selected DTI sequence on a single selected slice 
    and returns as output the MDR registered images, signal model fit, deformation field x, deformation field y, 
    fitted parameters FA and ADC, and the final diagnostics.
    &#34;&#34;&#34;
    start_computation_time = time.time()
    # define numpy array with same input shape as original DICOMs
    image_shape = np.shape(ArrayDicomiBEAt)
    original_images = np.zeros(image_shape)

    # initialise original_images with sorted acquisiton times to run MDR
    for i, s in enumerate(sorted_slice_files):
        img2d = s.pixel_array
        original_images[:, :, i] = img2d

    # read signal model parameters
    full_module_name = &#34;models.iBEAt_DTI&#34;
    signal_model_parameters = read_signal_model_parameters(full_module_name,filenameDCM, lstFilesDCM)
    # read signal model parameters
    elastix_model_parameters = read_elastix_model_parameters(Elastix_Parameter_file_PATH)
    
    #Perform MDR 
    MDR_output = model_driven_registration(original_images, image_parameters, signal_model_parameters, elastix_model_parameters, precision = 1)

    #Export results
    export_images(MDR_output[0], output_dir +&#39;/coregistered/MDR-registered_DTI_&#39;)
    export_images(MDR_output[1], output_dir +&#39;/fit/fit_image_&#39;)
    export_images(MDR_output[2][:,:,0,:], output_dir +&#39;/deformation_field/final_deformation_x_&#39;)
    export_images(MDR_output[2][:,:,1,:], output_dir +&#39;/deformation_field/final_deformation_y_&#39;)
    export_maps(MDR_output[3][2::4], output_dir + &#39;/fitted_parameters/FA&#39;, np.shape(original_images))
    export_maps(MDR_output[3][3::4], output_dir + &#39;/fitted_parameters/ADC&#39;, np.shape(original_images))
    MDR_output[4].to_csv(output_dir + &#39;DTI_largest_deformations.csv&#39;)

    # Report computation times
    end_computation_time = time.time()
    print(&#34;total computation time for MDR (minutes taken:)...&#34;)
    print(0.0166667*(end_computation_time - start_computation_time)) # in minutes
    print(&#34;completed MDR registration!&#34;)
    print(&#34;Finished processing Model Driven Registration case for iBEAt study DTI sequence!&#34;)</code></pre>
</details>
</dd>
<dt id="tests.MDR_test_DTI.main"><code class="name flex">
<span>def <span class="ident">main</span></span>(<span>)</span>
</code></dt>
<dd>
<div class="desc"></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def main():
    # selected sequence to process
    sequence = &#39;DTI&#39;
    # number of expected slices to process (example: iBEAt study number of slice = 30)
    slices = 30    

    # path definition  
    # your &#39;os.getcwd()&#39; path should point to your local directory containing the  MDR-Library 
    # eg: /Users/kanishkasharma/Documents/GitHub/MDR_Library
    print(os.getcwd()) 

    DATA_PATH = os.getcwd() + r&#39;/tests/test_data/DICOMs&#39;
    OUTPUT_REG_PATH = os.getcwd() + r&#39;/MDR_registration_output&#39;
    Elastix_Parameter_file_PATH = os.getcwd() + r&#39;/Elastix_Parameters_Files/iBEAt&#39; 
    output_dir =  OUTPUT_REG_PATH + &#39;/DTI/&#39;

    # Organize files per each sequence:
    os.chdir(DATA_PATH)    
    # list all patient folders available to be processed
    patients_folders = os.listdir()
    # select patient folder to be processed from the list of available patient DICOMs supplied in patients_folders
    for patient_folder in patients_folders:
        if patient_folder not in [&#39;test_case_iBEAt_4128009&#39;]: # eg: test case selected to be processed - change to your own test case
            continue
        # read path to the sequence to be processed for selected test patient case: eg: DTI
        sequence_images_path = patient_folder + &#39;/&#39; + str(sequence) + &#39;/DICOM&#39;
        os.chdir(DATA_PATH + &#39;/&#39; + sequence_images_path)
        # read all dicom files for selected sequence
        dcm_files_found = glob.glob(&#34;*.dcm&#34;)
        if not dcm_files_found:
            dcm_files_found = glob.glob(&#34;*.IMA&#34;) # if sequence is IMA format instead of dcm
        # slice to be processed from selected sequence
        for slice in range(1, slices+1):
            current_slice = sequence + &#39;_slice_&#39; + str(slice)
            # single slice processing for DTI sequence (here selected slice number is 15)
            if current_slice not in [sequence + &#39;_slice_15&#39;]:
                continue
            # read slice path to be processed
            slice_path = DATA_PATH + &#39;/&#39; + sequence_images_path + &#39;/&#39; + current_slice
            data = Path(slice_path)
            # list of all DICOMs to be processed for the selected slice (example: slice number = 15 here)
            lstFilesDCM = list(data.glob(&#39;**/*.IMA&#39;)) 
    
            # read all dicom files for the selected sequence and slice
            files, ArrayDicomiBEAt, filenameDCM = read_DICOM_files(lstFilesDCM)
            # get sitk image parameters for registration (origin and spacing)
            image_parameters = get_sitk_image_details_from_DICOM(slice_path)
            # sort slices correctly - based on acquisition time for model driven registration
            sorted_slice_files = sort_all_slice_files_acquisition_time(files)
            # run DTI MDR test 
            iBEAt_test_DTI(Elastix_Parameter_file_PATH, output_dir, sorted_slice_files, ArrayDicomiBEAt, image_parameters, filenameDCM, lstFilesDCM)</code></pre>
</details>
</dd>
<dt id="tests.MDR_test_DTI.read_DICOM_files"><code class="name flex">
<span>def <span class="ident">read_DICOM_files</span></span>(<span>lstFilesDCM)</span>
</code></dt>
<dd>
<div class="desc"></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def read_DICOM_files(lstFilesDCM):
    files = []
    RefDs = pydicom.dcmread(lstFilesDCM[0])
    SeriesPixelDims = (int(RefDs.Rows), int(RefDs.Columns), len(lstFilesDCM))           
    ArrayDicomiBEAt = np.zeros(SeriesPixelDims, dtype=RefDs.pixel_array.dtype)

    # read all dicoms and output dicom files
    for filenameDCM in lstFilesDCM: 
        files.append(pydicom.dcmread(filenameDCM))
        ds = pydicom.dcmread(filenameDCM)
        # write pixel data into numpy array
        ArrayDicomiBEAt[:, :, lstFilesDCM.index(filenameDCM)] = ds.pixel_array  

    return files, ArrayDicomiBEAt, filenameDCM</code></pre>
</details>
</dd>
<dt id="tests.MDR_test_DTI.read_elastix_model_parameters"><code class="name flex">
<span>def <span class="ident">read_elastix_model_parameters</span></span>(<span>Elastix_Parameter_file_PATH)</span>
</code></dt>
<dd>
<div class="desc"></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def read_elastix_model_parameters(Elastix_Parameter_file_PATH):
    elastix_model_parameters = itk.ParameterObject.New()
    elastix_model_parameters.AddParameterFile(Elastix_Parameter_file_PATH + &#34;/BSplines_DTI.txt&#34;)
    elastix_model_parameters.SetParameter(&#39;MaximumNumberOfIterations&#39;, &#39;1024&#39;)
    return elastix_model_parameters</code></pre>
</details>
</dd>
<dt id="tests.MDR_test_DTI.read_signal_model_parameters"><code class="name flex">
<span>def <span class="ident">read_signal_model_parameters</span></span>(<span>full_module_name, filenameDCM, lstFilesDCM)</span>
</code></dt>
<dd>
<div class="desc"></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def read_signal_model_parameters(full_module_name, filenameDCM, lstFilesDCM):

    # generate a module named as a string
    MODEL = importlib.import_module(full_module_name)
    b_values, bVec_original, image_orientation_patient = MODEL.read_dicom_tags_DTI(filenameDCM, lstFilesDCM)
    # select signal model paramters
    signal_model_parameters = [MODEL]
    signal_model_parameters.append([b_values, bVec_original, image_orientation_patient])
    return signal_model_parameters</code></pre>
</details>
</dd>
<dt id="tests.MDR_test_DTI.sort_all_slice_files_acquisition_time"><code class="name flex">
<span>def <span class="ident">sort_all_slice_files_acquisition_time</span></span>(<span>files)</span>
</code></dt>
<dd>
<div class="desc"></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def sort_all_slice_files_acquisition_time(files):
    slice_sorted_acq_time = []
    skipcount = 0
    for f in files: 
        if hasattr(f, &#39;AcquisitionTime&#39;):
            slice_sorted_acq_time.append(f)
        else:
            skipcount = skipcount + 1
    print(&#34;skipped, no AcquisitionTime: {}&#34;.format(skipcount))

    return sorted(slice_sorted_acq_time, key=lambda s: s.AcquisitionTime)  </code></pre>
</details>
</dd>
</dl>
</section>
<section>
</section>
</article>
<nav id="sidebar">
<h1>Index</h1>
<div class="toc">
<ul></ul>
</div>
<ul id="index">
<li><h3>Super-module</h3>
<ul>
<li><code><a title="tests" href="index.html">tests</a></code></li>
</ul>
</li>
<li><h3><a href="#header-functions">Functions</a></h3>
<ul class="">
<li><code><a title="tests.MDR_test_DTI.export_images" href="#tests.MDR_test_DTI.export_images">export_images</a></code></li>
<li><code><a title="tests.MDR_test_DTI.export_maps" href="#tests.MDR_test_DTI.export_maps">export_maps</a></code></li>
<li><code><a title="tests.MDR_test_DTI.get_sitk_image_details_from_DICOM" href="#tests.MDR_test_DTI.get_sitk_image_details_from_DICOM">get_sitk_image_details_from_DICOM</a></code></li>
<li><code><a title="tests.MDR_test_DTI.iBEAt_test_DTI" href="#tests.MDR_test_DTI.iBEAt_test_DTI">iBEAt_test_DTI</a></code></li>
<li><code><a title="tests.MDR_test_DTI.main" href="#tests.MDR_test_DTI.main">main</a></code></li>
<li><code><a title="tests.MDR_test_DTI.read_DICOM_files" href="#tests.MDR_test_DTI.read_DICOM_files">read_DICOM_files</a></code></li>
<li><code><a title="tests.MDR_test_DTI.read_elastix_model_parameters" href="#tests.MDR_test_DTI.read_elastix_model_parameters">read_elastix_model_parameters</a></code></li>
<li><code><a title="tests.MDR_test_DTI.read_signal_model_parameters" href="#tests.MDR_test_DTI.read_signal_model_parameters">read_signal_model_parameters</a></code></li>
<li><code><a title="tests.MDR_test_DTI.sort_all_slice_files_acquisition_time" href="#tests.MDR_test_DTI.sort_all_slice_files_acquisition_time">sort_all_slice_files_acquisition_time</a></code></li>
</ul>
</li>
</ul>
</nav>
</main>
<footer id="footer">
<p>Generated by <a href="https://pdoc3.github.io/pdoc"><cite>pdoc</cite> 0.9.1</a>.</p>
</footer>
</body>
</html>